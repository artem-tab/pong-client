<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Pong Vertical</title>
  <style>
    html, body { margin:0; height:100%; background:#000; overscroll-behavior:none; }
    #hud { position:fixed; top:12px; left:0; right:0; text-align:center; color:#fff; font:16px/1.2 sans-serif; }
    canvas { display:block; width:100vw; height:100vh; }
    .btn { position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:#111; color:#fff; border:1px solid #444; padding:10px 14px; border-radius:10px; }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- –í–ê–ñ–ù–û: –≤–∞—à —Å–µ—Ä–≤–µ—Ä Render -->
  <script src="https://pong-server-dl39.onrender.com/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="hud">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è‚Ä¶</div>
  <canvas id="game"></canvas>
  <button id="readyBtn" class="btn" style="display:none">–ò–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑</button>

  <script>
    const SERVER = "https://pong-server-dl39.onrender.com"; // –Ω–∞–ø—Ä–∏–º–µ—Ä: https://pong-server.onrender.com
    const socket = io(SERVER, { transports: ["websocket"] });

    const hud = document.getElementById('hud');
    const btn = document.getElementById('readyBtn');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    function resize() { canvas.width = innerWidth; canvas.height = innerHeight; }
    addEventListener('resize', resize); resize();

    let roomId = null;
    let side = "top"; // "top" –∏–ª–∏ "bottom"
    let state = null;

    socket.on('connect', () => { hud.textContent = '–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶'; });
    socket.on('waiting', msg => { hud.textContent = msg; });

    socket.on('start', ({ room, sideOf }) => {
      roomId = room;
      side = sideOf[socket.id] || "top";
      hud.textContent = '–ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω! üèì';
      btn.style.display = 'none';
    });

    socket.on('state', s => { state = s; render(); });
    socket.on('gameover', ({reason}) => { hud.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞: ' + reason; btn.style.display='block'; });
    btn.onclick = () => location.reload();

    // –£–ü–†–ê–í–õ–ï–ù–ò–ï: –ª–µ–≤—ã–π/–ø—Ä–∞–≤—ã–π ¬´–ø–æ–ª—ç–∫—Ä–∞–Ω–∞¬ª => –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ
    let left=false, right=false;
    function emitInput() {
      if (!roomId) return;
      socket.emit('input', { room: roomId, left, right });
    }
    function handlePointer(x) {
      left  = x < innerWidth/2;
      right = !left;
      emitInput();
    }
    addEventListener('touchstart', (e) => { handlePointer((e.touches[0]||e.changedTouches[0]).clientX); }, {passive:true});
    addEventListener('touchmove',  (e) => { handlePointer((e.touches[0]||e.changedTouches[0]).clientX); }, {passive:true});
    addEventListener('touchend',   () => { left=false; right=false; emitInput(); }, {passive:true});
    addEventListener('mousedown',  (e) => { handlePointer(e.clientX); });
    addEventListener('mousemove',  (e) => { if (e.buttons) handlePointer(e.clientX); });
    addEventListener('mouseup',    () => { left=false; right=false; emitInput(); });

    function render() {
      if (!state) return;
      const W = canvas.width, H = canvas.height;
      ctx.clearRect(0,0,W,H);

      // –º–∞—Å—à—Ç–∞–± –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –ø–∏–∫—Å–µ–ª–∏
      const sx = W / state.w, sy = H / state.h;
      const Sx = (x)=> x * sx, Sy = (y)=> y * sy;

      // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç–∏—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É (–¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞)
      ctx.fillStyle = "#222";
      for (let x=0; x<W; x+=20) ctx.fillRect(x, H/2-2, 10, 4);

      // –ú–Ø–ß
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(Sx(state.ball.x), Sy(state.ball.y), Math.max(3, state.ball.r * (sx+sy)/2), 0, Math.PI*2);
      ctx.fill();

      // –†–ê–ö–ï–¢–ö–ò (top/bottom)
      const pm = state.paddle.margin, pw = state.paddle.w, ph = state.paddle.h;
      // –≤–µ—Ä—Ö–Ω—è—è (–ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–≤–µ—Ä—Ö—É)
      ctx.fillRect(Sx(state.p1.x - pw/2), Sy(pm), Sx(pw), Sy(ph));
      // –Ω–∏–∂–Ω—è—è (–ø–æ —Ü–µ–Ω—Ç—Ä—É —Å–Ω–∏–∑—É)
      ctx.fillRect(Sx(state.p2.x - pw/2), Sy(state.h - pm - ph), Sx(pw), Sy(ph));

      // –°–ß–Å–¢ ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π, —Å–µ—Ä—ã–π, –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —Å–±–æ–∫—É –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ
      ctx.save();
      ctx.globalAlpha = 0.5;
      ctx.fillStyle = "#aaa";
      ctx.font = Math.floor(H * 0.04) + "px sans-serif"; // –º–∞–ª–µ–Ω—å–∫–∏–π
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.fillText(`${state.p1.score} : ${state.p2.score}`, Math.floor(W * 0.05), Math.floor(H / 2));
      ctx.restore();
    }

    // Telegram Mini App ‚Äî –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ, –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ Telegram
    const tg = window.Telegram?.WebApp;
    if (tg) { try { tg.expand(); } catch(_){} }
  </script>
</body>
</html>
